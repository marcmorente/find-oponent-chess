$(document).ready((function(){var e=[];function a(e){var a=e.header();null==a.WhiteElo?a.WhiteElo="":a.WhiteElo=" ("+a.WhiteElo+")",null==a.BlackElo?a.BlackElo="":a.BlackElo=" ("+a.BlackElo+")";var t="<h4>"+a.White+a.WhiteElo+" - "+a.Black+a.BlackElo+"</h4>";t+="<h5>"+a.Event+", "+a.Site+" "+a.EventDate+"</h5>";var n,o=e.pgn().replace(/\[(.*?)\]/gm,"").replace(a.Result,"").trim();moveArray=o.split(/([0-9]+\.\s)/).filter((function(e){return e}));for(var r=0,l=moveArray.length;r<l;++r){var i=$.trim(moveArray[r]);if(!/^[0-9]+\.$/.test(i)){m=i.split(/\s+/);for(var s=0,c=m.length;s<c;++s)m[s]='<span class="gameMove'+(r+s-1)+' move" data-value="'+(r+s-1)+'"><a id="myLink" href="#" value="'+(r+s-1)+'">'+m[s]+"</a></span>";i=m.join(" ")}moveArray[r]=i}var d=t+'<div class="gameMoves">'+moveArray.join(" ");a.Result&&(d+=' <span class="gameResult">'+a.Result+"</span></div>"),$("#game-data").html(d)}function t(e){e>i.length-1&&(e=i.length-1),r.reset();for(var a=0;a<=e;a++)r.move(i[a].san);s=a-1,o.position(r.fen())}$("#btnStart").on("click",(function(){r.reset(),s=-1,o.position(r.fen()),$("#currentFen").val(r.fen())})),$("#btnPrevious").on("click",(function(){s>=0&&(r.undo(),s--,o.position(r.fen()),$("#currentFen").val(r.fen()))})),$("#btnNext").on("click",(function(){s<i.length-1&&(s++,r.move(i[s].san),o.position(r.fen()),$("#currentFen").val(r.fen()))})),$("#btnEnd").on("click",(function(){for(;s<i.length-1;)s++,r.move(i[s].san);o.position(r.fen()),$("#currentFen").val(r.fen())}));var n=function e(){$("[class^='gameMove']").removeClass("highlight"),$(".gameMove"+s).addClass("highlight")},o,r,l,i,s,c;function d(e){return e.history().map((function(a){return e.move(a),e.fen()}))}function u(n){(r=new Chess).load_pgn(e[n].join("\n"),{newline_char:"\n"}),a(r),i=r.history({verbose:!0}),t(-1),c=n}function v(){$("#find_player").prop("disabled",!1)}$(document).keydown((function(a){return 39==a.keyCode?(a.ctrlKey?$("#btnEnd").click():$("#btnNext").click(),!1):37==a.keyCode?(a.ctrlKey?$("#btnStart").click():$("#btnPrevious").click(),!1):38==a.keyCode?(c>0&&(a.ctrlKey?u(0):u(c-1)),$("#gameSelect").val(c),!1):40==a.keyCode?(c<e.length-1&&(a.ctrlKey?u(e.length-1):u(c+1)),$("#gameSelect").val(c),!1):void 0})),$(document).delegate("#find_player","click",(function(a){a.preventDefault(),$("body, input").addClass("wait"),$("#find_player").prop("disabled",!0),o=new ChessBoard("board",h),$(window).resize(o.resize),$("#table").hide(),$("#game-data").hide();var t=[];e.length=0;var n=$("#player_name").val().toString().replace(",","");if(""==n)return alert("Has d'omplir algun nom"),v(),$("body, input").removeClass("wait"),!1;if(n.length<2)return alert("Has de posar un nom amb més d'una lletra"),v(),$("body, input").removeClass("wait"),!1;var r={player_name:n};$.ajax({data:r,dataType:"json",url:"src/ajaxrequest/get_games_player.php",type:"POST",error:function(e,a,t){v(),console.log("Error: "+JSON.parse(t)+" "+JSON.parse(a)+" "+JSON.parse(e))},success:function(a){if($("body, input").removeClass("wait"),"not_found"!=a.toString()){for(var n=0;n<a.length;n++){e.push(a[n]);var o=new Chess,r,l;o.load_pgn(a[n].join("\n"),{newline_char:"\n"});var i=o.header();void 0===i.Date&&(i.Date="-"),void 0===i.ECO&&(i.ECO="-"),void 0===i.Event&&(i.Event="-"),void 0===i.Result&&(i.Result="-"),void 0!==i.White&&void 0!==i.Black&&t.push({tournament:i.Event,year:i.Date,white:i.White,black:i.Black,result:i.Result,eco:i.ECO,btn:'<button class="edit btn btn-success show-pgn" value="'+n+'" type="button" title="Veure partida"><i class="fa fa-eye fa-lg"></i></button>'})}v(),$("#myTable").DataTable({data:t,pageLength:15,destroy:!0,order:[[0,"desc"]],columns:[{data:"tournament"},{data:"year"},{data:"white"},{data:"black"},{data:"result"},{data:"eco"},{data:"btn"}]}),$("#table").show()}else alert("No s'ha trobat cap partida amb aquest criteri de búsqueda "),v()}})})),$(document).delegate(".show-pgn","click",(function(){var e;u($(this).val()),$("#game-data").show(),$("html, body").animate({scrollTop:0},"slow")})),$(document).delegate("#currentFen","click",(function(e){var a="https://lichess.org/analysis/standard/"+$(this).val();window.open(a,"_blank")})),$(document).delegate(".move","click",(function(){var e;t($(this).attr("data-value"))}));var h={pieceTheme:"chessboardjs/img/chesspieces/wikipedia/{piece}.png",position:"start",showNotation:!0,onChange:n};o=new ChessBoard("board",h),$(window).resize(o.resize)}));